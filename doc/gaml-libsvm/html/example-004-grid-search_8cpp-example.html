<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>gaml-libsvm: example-004-grid-search.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">gaml-libsvm
   &#160;<span id="projectnumber">1.05</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">example-004-grid-search.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="gaml-libsvm_8hpp.html">gaml-libsvm.hpp</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cstdlib&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;array&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;utility&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;ctime&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> std::pair&lt;double,double&gt; X;</div><div class="line"><span class="keyword">typedef</span> <span class="keywordtype">bool</span>                     U;  </div><div class="line"><span class="keyword">typedef</span> std::pair&lt;X,U&gt;           Data;</div><div class="line"><span class="keyword">typedef</span> std::vector&lt;Data&gt;        DataSet;</div><div class="line"></div><div class="line"><span class="comment">// This is a ckecker.</span></div><div class="line">U oracle(<span class="keyword">const</span> X&amp; x) {</div><div class="line">  <span class="keywordflow">return</span> std::sin(x.first) * std::sin(x.second) &gt; 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">const</span> X&amp;  <a name="a0"></a><a class="code" href="namespacegaml_1_1libsvm.html#a49603fe1f50e0255a89dcccdb0a64ad7">input_of</a> (<span class="keyword">const</span> Data&amp; d) {<span class="keywordflow">return</span> d.first;}</div><div class="line">U        output_of (<span class="keyword">const</span> Data&amp; d) {<span class="keywordflow">return</span> d.second;}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> nb_nodes_of(<span class="keyword">const</span> X&amp; x) {</div><div class="line">  <span class="keywordflow">return</span> 3;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> fill_nodes(<span class="keyword">const</span> X&amp; x,<span class="keyword">struct</span> svm_node* nodes) {</div><div class="line">  nodes[0].index = 1;</div><div class="line">  nodes[0].value = x.first;  <span class="comment">// x </span></div><div class="line">  nodes[1].index = 2;</div><div class="line">  nodes[1].value = x.second; <span class="comment">// y</span></div><div class="line">  nodes[2].index = -1;       <span class="comment">// end</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// This defines the discrete values for C and sigma</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define NB_Cs     5</span></div><div class="line"><span class="preprocessor">#define NB_SIGMAs 5</span></div><div class="line"></div><div class="line"><span class="comment">// This defines the parameter grid.</span></div><div class="line">std::array&lt;double, NB_Cs    &gt; Cs     = {{.1,  1, 10, 100, 1000}};</div><div class="line">std::array&lt;double, NB_SIGMAs&gt; sigmas = {{.1, .5,  1,   3,    5}};</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// This fits the gaml::concept::Learner concept.</span></div><div class="line"><span class="keyword">class </span>GridSearch {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="keyword">typedef</span> <a name="_a1"></a><a class="code" href="classgaml_1_1libsvm_1_1Predictor.html">gaml::libsvm::Predictor&lt;X,U&gt;</a> predictor_type;</div><div class="line"></div><div class="line">  <span class="keywordtype">bool</span> verbose;</div><div class="line"></div><div class="line">  GridSearch(<span class="keywordtype">void</span>)                    : verbose(<span class="keyword">false</span>)         {}</div><div class="line">  GridSearch(<span class="keyword">const</span> GridSearch&amp; other) : verbose(other.verbose) {}</div><div class="line"></div><div class="line">  <span class="comment">// This does the learning, and returns a predictor from the data.</span></div><div class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> DataIterator, <span class="keyword">typename</span> InputOf, <span class="keyword">typename</span> OutputOf&gt;</div><div class="line">  predictor_type operator()(<span class="keyword">const</span> DataIterator&amp; begin, <span class="keyword">const</span> DataIterator&amp; end,</div><div class="line">                            <span class="keyword">const</span> InputOf&amp; <a class="code" href="namespacegaml_1_1libsvm.html#a49603fe1f50e0255a89dcccdb0a64ad7">input_of</a>, <span class="keyword">const</span> OutputOf&amp; output_of)<span class="keyword"> const </span>{</div><div class="line">    </div><div class="line">    <span class="keyword">struct </span>svm_parameter params;</div><div class="line">    <a name="a2"></a><a class="code" href="namespacegaml_1_1libsvm.html#a0aa2ab4dc77084e5a0a667fe170d25ab">gaml::libsvm::init</a>(params);</div><div class="line">    params.eps         = 1e-5;</div><div class="line">    params.svm_type    = C_SVC;</div><div class="line">    params.kernel_type = RBF;</div><div class="line"></div><div class="line">    <span class="keyword">auto</span> risk_estimator = gaml::risk::cross_validation(gaml::loss::Classification&lt;U&gt;(),</div><div class="line">                                                       gaml::partition::kfold(5), <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> best_risk  = std::numeric_limits&lt;double&gt;::max();</div><div class="line">    <span class="keywordtype">double</span> best_C     = 0;</div><div class="line">    <span class="keywordtype">double</span> best_sigma = 0;</div><div class="line"></div><div class="line">    <span class="comment">// Grid search here...</span></div><div class="line">    <span class="keywordflow">if</span>(verbose) </div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Starting the grid search&quot;</span> &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">for</span>(<span class="keywordtype">double</span> sigma : sigmas) {</div><div class="line">      params.gamma = 1/(2*sigma*sigma);</div><div class="line">      <span class="keywordflow">for</span>(<span class="keywordtype">double</span> C : Cs) {</div><div class="line">        params.C = C;</div><div class="line">        <span class="keywordflow">if</span>(verbose) </div><div class="line">          std::cout &lt;&lt; <span class="stringliteral">&quot;  sigma = &quot;</span> &lt;&lt; std::setw(5) &lt;&lt; sigma </div><div class="line">                    &lt;&lt; <span class="stringliteral">&quot;, C = &quot;</span>     &lt;&lt; std::setw(5) &lt;&lt; C </div><div class="line">                    &lt;&lt; <span class="stringliteral">&quot; -&gt; risk = &quot;</span> &lt;&lt; std::flush;</div><div class="line">        <span class="keywordtype">double</span> risk = risk_estimator(gaml::libsvm::supervized::learner&lt;X,U&gt;(params, nb_nodes_of, fill_nodes),</div><div class="line">                                     begin, end, input_of, output_of);</div><div class="line">        <span class="keywordflow">if</span>(verbose) std::cout &lt;&lt; risk;</div><div class="line">        <span class="keywordflow">if</span>(risk &lt; best_risk) {</div><div class="line">          best_risk = risk;</div><div class="line">          best_C = C;</div><div class="line">          best_sigma = sigma;</div><div class="line">          <span class="keywordflow">if</span>(verbose) std::cout &lt;&lt; <span class="stringliteral">&quot; (new minimum)&quot;</span>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(verbose) std::cout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Let us return a predictor from a SVM with the best parameters.</span></div><div class="line">    params.gamma = 1/(2*best_sigma*best_sigma);</div><div class="line">    params.C     = best_C;</div><div class="line">    <span class="keywordflow">if</span>(verbose) std::cout &lt;&lt; <span class="stringliteral">&quot;  Learning the predictor with best parameters (sigma = &quot;</span></div><div class="line">                          &lt;&lt; best_sigma &lt;&lt; <span class="stringliteral">&quot;, C = &quot;</span> &lt;&lt; best_C </div><div class="line">                          &lt;&lt; <span class="stringliteral">&quot;, risk = &quot;</span> &lt;&lt; best_risk </div><div class="line">                          &lt;&lt; <span class="stringliteral">&quot;)... &quot;</span> &lt;&lt; std::flush;</div><div class="line"></div><div class="line">    <span class="keyword">auto</span> <a name="a3"></a><a class="code" href="namespacegaml_1_1libsvm_1_1supervized.html#a0cad529a46c5a6f68399579926d1955f">learner</a> = gaml::libsvm::supervized::learner&lt;X,U&gt;(params, nb_nodes_of, fill_nodes);</div><div class="line">    <span class="keyword">auto</span> pred    = <a class="code" href="namespacegaml_1_1libsvm_1_1supervized.html#a0cad529a46c5a6f68399579926d1955f">learner</a>(begin, end, input_of, output_of);</div><div class="line">    <span class="keywordflow">if</span>(verbose) std::cout &lt;&lt; <span class="stringliteral">&quot;Done.&quot;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> pred;</div><div class="line">  }</div><div class="line"></div><div class="line">};</div><div class="line"><span class="preprocessor">#define PPM_SIDE 500</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> DECISION&gt;</div><div class="line"><span class="keywordtype">void</span> plot_decision(<span class="keyword">const</span> DECISION&amp; f) {</div><div class="line">  std::ofstream ppm(<span class="stringliteral">&quot;decision.ppm&quot;</span>);</div><div class="line">  </div><div class="line">  ppm &lt;&lt; <span class="stringliteral">&quot;P5&quot;</span> &lt;&lt; std::endl</div><div class="line">      &lt;&lt; PPM_SIDE &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; PPM_SIDE &lt;&lt; std::endl</div><div class="line">      &lt;&lt; <span class="stringliteral">&quot;255&quot;</span> &lt;&lt; std::endl;</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> coef = 10/(PPM_SIDE-1.0);</div><div class="line">  <span class="keywordtype">int</span> w,h;</div><div class="line">  X p;</div><div class="line">  <span class="keywordflow">for</span>(h = PPM_SIDE-1; h &gt;= 0; --h) {</div><div class="line">    p.second = -5 + h*coef;</div><div class="line">    <span class="keywordflow">for</span>(w = 0; w &lt; PPM_SIDE; ++w) {</div><div class="line">      p.first = -5 + w*coef;</div><div class="line">      <span class="keywordflow">if</span>(f(p))</div><div class="line">        ppm.put((<span class="keywordtype">char</span>)255);</div><div class="line">      <span class="keywordflow">else</span></div><div class="line">        ppm.put((<span class="keywordtype">char</span>)0);</div><div class="line">    }</div><div class="line">  }</div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Image \&quot;decision.ppm\&quot; generated&quot;</span> &lt;&lt; std::endl;</div><div class="line">  ppm.close();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div><div class="line"></div><div class="line">  <span class="comment">// Let us make libsvm quiet</span></div><div class="line">  <a name="a4"></a><a class="code" href="namespacegaml_1_1libsvm.html#a260e3b65a07aba27bac89dd3b9cfa468">gaml::libsvm::quiet</a>();</div><div class="line">  <span class="comment">// random seed initialization</span></div><div class="line">  std::srand(std::time(0));</div><div class="line"></div><div class="line">  DataSet basis;</div><div class="line"></div><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Building the sample set.&quot;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">  <span class="comment">// Let us fill some databasis.</span></div><div class="line">  basis.resize(1000);</div><div class="line">  <span class="keywordflow">for</span>(<span class="keyword">auto</span>&amp; data : basis) {</div><div class="line">    X x = {gaml::random::uniform(-5,5),gaml::random::uniform(-5,5)};</div><div class="line">    data = {x, oracle(x)};</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">try</span> {</div><div class="line">    GridSearch <a class="code" href="namespacegaml_1_1libsvm_1_1supervized.html#a0cad529a46c5a6f68399579926d1955f">learner</a>; <span class="comment">// This learner uses an internal cross-validation.</span></div><div class="line">    learner.verbose = <span class="keyword">true</span>;</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Applying grid search...&quot;</span> &lt;&lt; std::endl</div><div class="line">              &lt;&lt; std::endl;</div><div class="line">    <span class="keyword">auto</span> pred = <a class="code" href="namespacegaml_1_1libsvm_1_1supervized.html#a0cad529a46c5a6f68399579926d1955f">learner</a>(basis.begin(), basis.end(), <a class="code" href="namespacegaml_1_1libsvm.html#a49603fe1f50e0255a89dcccdb0a64ad7">input_of</a>, output_of);</div><div class="line">   </div><div class="line">    <span class="keyword">auto</span> emp_eval = gaml::risk::empirical(gaml::loss::Classification&lt;U&gt;());</div><div class="line">    std::cout &lt;&lt; std::endl</div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;Empirical risk : &quot;</span> </div><div class="line">              &lt;&lt; emp_eval(pred, basis.begin(), basis.end(), <a class="code" href="namespacegaml_1_1libsvm.html#a49603fe1f50e0255a89dcccdb0a64ad7">input_of</a>, output_of)</div><div class="line">              &lt;&lt; std::endl </div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;Drawing decision function...&quot;</span> &lt;&lt; std::endl;</div><div class="line">    plot_decision(pred);</div><div class="line"></div><div class="line">    <span class="comment">// Now, we can estimate the real risk of the whole grid search</span></div><div class="line">    <span class="comment">// process... this leads to an intrication of cross-validations.</span></div><div class="line">    </div><div class="line">    learner.verbose = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">auto</span> real_eval  = gaml::risk::cross_validation(gaml::loss::Classification&lt;U&gt;(), gaml::partition::kfold(5), <span class="keyword">true</span>);</div><div class="line">    <span class="keywordtype">double</span> risk     = real_eval(learner, basis.begin(), basis.end(), <a class="code" href="namespacegaml_1_1libsvm.html#a49603fe1f50e0255a89dcccdb0a64ad7">input_of</a>, output_of);</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;The grid search procedure has the following estimated real risk : &quot;</span> &lt;&lt; risk &lt;&lt; std::endl;</div><div class="line">  }</div><div class="line">  <span class="keywordflow">catch</span>(gaml::exception::Any&amp; e) {</div><div class="line">    std::cout &lt;&lt; e.what() &lt;&lt; std::endl;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Oct 31 2016 12:07:16 for gaml-libsvm by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
